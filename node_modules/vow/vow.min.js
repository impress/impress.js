/**
 * @module vow
 * @author Filatov Dmitry <dfilatov@yandex-team.ru>
 * @version 0.4.17
 * @license
 * Dual licensed under the MIT and GPL licenses:
 *   * http://www.opensource.org/licenses/mit-license.php
 *   * http://www.gnu.org/licenses/gpl.html
 */(function(e){var t,n=function(){var t=[],n=function(e){return t.push(e),t.length===1},r=function(){var e=t,n=0,r=t.length;t=[];while(n<r)e[n++]()};if(typeof setImmediate=="function")return function(e){n(e)&&setImmediate(r)};if(typeof process=="object"&&process.nextTick)return function(e){n(e)&&process.nextTick(r)};var i=e.MutationObserver||e.WebKitMutationObserver;if(i){var s=1,o=document.createTextNode("");return(new i(r)).observe(o,{characterData:!0}),function(e){n(e)&&(o.data=s*=-1)}}if(e.postMessage){var u=!0;if(e.attachEvent){var a=function(){u=!1};e.attachEvent("onmessage",a),e.postMessage("__checkAsync","*"),e.detachEvent("onmessage",a)}if(u){var f="__promise"+Math.random()+"_"+new Date,l=function(e){e.data===f&&(e.stopPropagation&&e.stopPropagation(),r())};return e.addEventListener?e.addEventListener("message",l,!0):e.attachEvent("onmessage",l),function(t){n(t)&&e.postMessage(f,"*")}}}var c=e.document;if("onreadystatechange"in c.createElement("script")){var h=function(){var e=c.createElement("script");e.onreadystatechange=function(){e.parentNode.removeChild(e),e=e.onreadystatechange=null,r()},(c.documentElement||c.body).appendChild(e)};return function(e){n(e)&&h()}}return function(e){n(e)&&setTimeout(r,0)}}(),r=function(e){n(function(){throw e})},i=function(e){return typeof e=="function"},s=function(e){return e!==null&&typeof e=="object"},o=Object.prototype.toString,u=Array.isArray||function(e){return o.call(e)==="[object Array]"},a=function(e){var t=[],n=0,r=e.length;while(n<r)t.push(n++);return t},f=Object.keys||function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(n);return t},l=function(e){var t=function(t){this.name=e,this.message=t};return t.prototype=new Error,t},c=function(e,t){return function(n){e.call(this,n,t)}},h=e.PromiseRejectionEvent?function(t,n){new e.PromiseRejectionEvent("unhandledrejection",{promise:n,reason:t})}:typeof process=="object"&&process.emit?function(e,t){process.emit("unhandledRejection",e,t)}:function(){},p=function(){this._promise=new v};p.prototype={promise:function(){return this._promise},resolve:function(e){this._promise.isResolved()||this._promise._resolve(e)},reject:function(e){if(this._promise.isResolved())return;y.isPromise(e)?(e=e.then(function(e){var t=y.defer();return t.reject(e),t.promise()}),this._promise._resolve(e)):this._promise._reject(e)},notify:function(e){this._promise.isResolved()||this._promise._notify(e)}};var d={PENDING:0,RESOLVED:1,FULFILLED:2,REJECTED:3},v=function(e){this._value=t,this._status=d.PENDING,this._shouldEmitUnhandledRejection=!0,this._fulfilledCallbacks=[],this._rejectedCallbacks=[],this._progressCallbacks=[];if(e){var n=this,r=e.length;try{e(function(e){n.isResolved()||n._resolve(e)},r>1?function(e){n.isResolved()||n._reject(e)}:t,r>2?function(e){n.isResolved()||n._notify(e)}:t)}catch(i){this._reject(i)}}};v.prototype={valueOf:function(){return this._value},isResolved:function(){return this._status!==d.PENDING},isFulfilled:function(){return this._status===d.FULFILLED},isRejected:function(){return this._status===d.REJECTED},then:function(e,t,n,r){this._shouldEmitUnhandledRejection=!1;var i=new p;return this._addCallbacks(i,e,t,n,r),i.promise()},"catch":function(e,n){return this.then(t,e,n)},fail:function(e,n){return this.then(t,e,n)},always:function(e,t){var n=this,r=function(){return e.call(this,n)};return this.then(r,r,t)},progress:function(e,n){return this.then(t,t,e,n)},spread:function(e,t,n){return this.then(function(t){return e.apply(this,t)},t,n)},done:function(e,t,n,i){this.then(e,t,n,i).fail(r)},delay:function(e){var t,n=this.then(function(n){var r=new p;return t=setTimeout(function(){r.resolve(n)},e),r.promise()});return n.always(function(){clearTimeout(t)}),n},timeout:function(e){var t=new p,n=setTimeout(function(){t.reject(new y.TimedOutError("timed out"))},e);return this.then(function(e){t.resolve(e)},function(e){t.reject(e)}),t.promise().always(function(){clearTimeout(n)}),t.promise()},_vow:!0,_resolve:function(e){if(this._status>d.RESOLVED)return;if(e===this){this._reject(TypeError("Can't resolve promise with itself"));return}this._status=d.RESOLVED;if(e&&!!e._vow){e.isFulfilled()?this._fulfill(e.valueOf()):e.isRejected()?(e._shouldEmitUnhandledRejection=!1,this._reject(e.valueOf())):e.then(this._fulfill,this._reject,this._notify,this);return}if(s(e)||i(e)){var t;try{t=e.then}catch(n){this._reject(n);return}if(i(t)){var r=this,o=!1;try{t.call(e,function(e){if(o)return;o=!0,r._resolve(e)},function(e){if(o)return;o=!0,r._reject(e)},function(e){r._notify(e)})}catch(n){o||this._reject(n)}return}}this._fulfill(e)},_fulfill:function(e){if(this._status>d.RESOLVED)return;this._status=d.FULFILLED,this._value=e,this._callCallbacks(this._fulfilledCallbacks,e),this._fulfilledCallbacks=this._rejectedCallbacks=this._progressCallbacks=t},_reject:function(e){if(this._status>d.RESOLVED)return;this._status=d.REJECTED,this._value=e,this._callCallbacks(this._rejectedCallbacks,e);if(!this._rejectedCallbacks.length){var r=this;n(function(){r._shouldEmitUnhandledRejection&&h(e,r)})}this._fulfilledCallbacks=this._rejectedCallbacks=this._progressCallbacks=t},_notify:function(e){this._callCallbacks(this._progressCallbacks,e)},_addCallbacks:function(e,n,r,s,o){r&&!i(r)?(o=r,r=t):s&&!i(s)&&(o=s,s=t),r&&(this._shouldEmitUnhandledRejection=!1);var u;this.isRejected()||(u={defer:e,fn:i(n)?n:t,ctx:o},this.isFulfilled()?this._callCallbacks([u],this._value):this._fulfilledCallbacks.push(u)),this.isFulfilled()||(u={defer:e,fn:r,ctx:o},this.isRejected()?this._callCallbacks([u],this._value):this._rejectedCallbacks.push(u)),this._status<=d.RESOLVED&&this._progressCallbacks.push({defer:e,fn:s,ctx:o})},_callCallbacks:function(e,t){var r=e.length;if(!r)return;var i=this.isResolved(),s=this.isFulfilled(),o=this.isRejected();n(function(){var n=0,i,u,a;while(n<r){i=e[n++],u=i.defer,a=i.fn;if(a){var f=i.ctx,l;try{l=f?a.call(f,t):a(t)}catch(c){u.reject(c);continue}s||o?u.resolve(l):u.notify(l)}else s?u.resolve(t):o?u.reject(t):u.notify(t)}})}};var m={cast:function(e){return y.cast(e)},all:function(e){return y.all(e)},race:function(e){return y.anyResolved(e)},resolve:function(e){return y.resolve(e)},reject:function(e){return y.reject(e)}};for(var g in m)m.hasOwnProperty(g)&&(v[g]=m[g]);var y={Deferred:p,Promise:v,defer:function(){return new p},when:function(e,t,n,r,i){return y.cast(e).then(t,n,r,i)},fail:function(e,n,r){return y.when(e,t,n,r)},always:function(e,t,n){return y.when(e).always(t,n)},progress:function(e,t,n){return y.when(e).progress(t,n)},spread:function(e,t,n,r){return y.when(e).spread(t,n,r)},done:function(e,t,n,r,i){y.when(e).done(t,n,r,i)},isPromise:function(e){return s(e)&&i(e.then)},cast:function(e){return e&&!!e._vow?e:y.resolve(e)},valueOf:function(e){return e&&i(e.valueOf)?e.valueOf():e},isFulfilled:function(e){return e&&i(e.isFulfilled)?e.isFulfilled():!0},isRejected:function(e){return e&&i(e.isRejected)?e.isRejected():!1},isResolved:function(e){return e&&i(e.isResolved)?e.isResolved():!0},resolve:function(e){var t=y.defer();return t.resolve(e),t.promise()},fulfill:function(e){var t=y.defer(),n=t.promise();return t.resolve(e),n.isFulfilled()?n:n.then(null,function(e){return e})},reject:function(e){var t=y.defer();return t.reject(e),t.promise()},invoke:function(t,n){var r=Math.max(arguments.length-1,0),i;if(r){i=Array(r);var s=0;while(s<r)i[s++]=arguments[s]}try{return y.resolve(i?t.apply(e,i):t.call(e))}catch(o){return y.reject(o)}},all:function(e){var t=new p,n=u(e),r=n?a(e):f(e),i=r.length,s=n?[]:{};if(!i)return t.resolve(s),t.promise();var o=i;return y._forEach(e,function(e,n){s[r[n]]=e,--o||t.resolve(s)},t.reject,t.notify,t,r),t.promise()},allResolved:function(e){var t=new p,n=u(e),r=n?a(e):f(e),i=r.length,s=n?[]:{};if(!i)return t.resolve(s),t.promise();var o=function(){--i||t.resolve(e)};return y._forEach(e,o,o,t.notify,t,r),t.promise()},allPatiently:function(e){return y.allResolved(e).then(function(){var t=u(e),n=t?a(e):f(e),r,i,s=n.length,o=0,l,c;if(!s)return t?[]:{};while(o<s)l=n[o++],c=e[l],y.isRejected(c)?(r||(r=t?[]:{}),t?r.push(c.valueOf()):r[l]=c.valueOf()):r||((i||(i=t?[]:{}))[l]=y.valueOf(c));if(r)throw r;return i})},any:function(e){var t=new p,n=e.length;if(!n)return t.reject(Error()),t.promise();var r=0,i;return y._forEach(e,t.resolve,function(e){r||(i=e),++r===n&&t.reject(i)},t.notify,t),t.promise()},anyResolved:function(e){var t=new p,n=e.length;return n?(y._forEach(e,t.resolve,t.reject,t.notify,t),t.promise()):(t.reject(Error()),t.promise())},delay:function(e,t){return y.resolve(e).delay(t)},timeout:function(e,t){return y.resolve(e).timeout(t)},_forEach:function(e,t,n,r,i,s){var o=s?s.length:e.length,u=0;while(u<o)y.when(e[s?s[u]:u],c(t,u),n,r,i),++u},TimedOutError:l("TimedOut")},b=!0;typeof module=="object"&&typeof module.exports=="object"&&(module.exports=y,b=!1),typeof modules=="object"&&i(modules.define)&&(modules.define("vow",function(e){e(y)}),b=!1),typeof define=="function"&&(define(function(e,t,n){n.exports=y}),b=!1),b&&(e.vow=y)})(typeof window!="undefined"?window:global);